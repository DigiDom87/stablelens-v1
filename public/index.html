<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>StableLens v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0e11;
      --card: #12161c;
      --text: #e9edf1;
      --muted: #9aa4ad;
      --accent: #5dd8ff;
      --ok: #27ae60;
      --warn: #f39c12;
      --bad: #e74c3c;
      --border: #1c2430;
    }
    .light {
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #0ea5e9;
      --ok: #059669;
      --warn: #d97706;
      --bad: #dc2626;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding: 16px 20px; border-bottom:1px solid var(--border);
      position: sticky; top: 0; backdrop-filter: blur(6px);
    }
    .brand { display:flex; gap:10px; align-items:center; font-weight:700; letter-spacing:.2px; }
    .tabs { display:flex; flex-wrap:wrap; gap:8px; }
    .tab { padding:8px 12px; border:1px solid var(--border); border-radius:10px; cursor:pointer; background:var(--card); color:var(--text); }
    .tab.active { outline: 2px solid var(--accent); }
    .theme { border:1px solid var(--border); padding:8px 12px; border-radius:10px; background:var(--card); cursor:pointer; }
    main { max-width:1100px; margin: 24px auto; padding: 0 16px; display:grid; gap:16px; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(2, 1fr); }
    .card { background: var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .card h3 { margin:0 0 8px 0; font-size:16px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:8px; border-bottom:1px solid var(--border); text-align:left; }
    .muted { color: var(--muted); }
    .pill { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:transparent;}
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }
    .hidden { display:none; }
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:10px; }
    input[type="range"] { width: 160px; }
    a { color: var(--accent); text-decoration:none; }
  </style>
</head>
<body class="dark">
  <header>
    <div class="brand">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor"/><path d="M7 12h10M12 7v10" stroke="currentColor"/></svg>
      <div>StableLens <span class="muted">v1</span></div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="overview">Overview</button>
      <button class="tab" data-tab="stablecoins">Stablecoins</button>
      <button class="tab" data-tab="yields">Yields</button>
      <button class="tab" data-tab="platforms">Platforms</button>
      <button class="tab" data-tab="news">News</button>
      <button class="tab" data-tab="alerts">Alerts</button>
      <button id="theme" class="theme">Theme</button>
    </div>
  </header>

  <main>
    <!-- Overview -->
    <section id="overview" class="grid">
      <div class="card">
        <h3>Health</h3>
        <div id="healthLine" class="muted">—</div>
      </div>
      <div class="card">
        <h3>Last Updated</h3>
        <div id="statusLine" class="muted">—</div>
      </div>
      <div class="card">
        <h3>Quick Peg Monitor</h3>
        <div class="muted" id="pegNote">Prices not wired in v1 (safe mode). Depeg alerts will appear if available.</div>
      </div>
      <div class="card">
        <h3>APY Summary (Top entries)</h3>
        <div id="apySummary" class="muted">Loading…</div>
      </div>
    </section>

    <!-- Stablecoins -->
    <section id="stablecoins" class="hidden">
      <div class="card">
        <div class="controls">
          <label class="muted">Min score:
            <input id="scoreFilter" type="range" min="1" max="10" step="0.5" value="6" />
            <span id="scoreVal" class="pill">6.0</span>
          </label>
        </div>
        <table id="stableTable">
          <thead>
            <tr>
              <th>Symbol</th><th>Name</th><th>Issuer</th><th>Jurisdiction</th><th>Auditor</th><th>Model</th><th>Score</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Yields -->
    <section id="yields" class="hidden">
      <div class="card">
        <div class="controls">
          <label class="muted">Symbol:
            <select id="yieldSymbol">
              <option value="">All</option>
              <option>USDC</option><option>USDT</option><option>DAI</option><option>sDAI</option><option>FRAX</option><option>PYUSD</option><option>GHO</option>
            </select>
          </label>
        </div>
        <table id="yieldTable">
          <thead>
            <tr>
              <th>Project</th><th>Chain</th><th>Symbol</th><th>APY</th><th>TVL ($)</th><th>Pool</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Platforms -->
    <section id="platforms" class="hidden">
      <div class="grid">
        <div class="card">
          <h3>CeFi Platforms</h3>
          <table id="cefiTable">
            <thead>
              <tr>
                <th>Name</th><th>Jurisdiction</th><th>Licenses</th><th>PoR</th><th>Score</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>DeFi Platforms</h3>
          <table id="defiTable">
            <thead>
              <tr>
                <th>Name</th><th>Chain</th><th>Audits</th><th>Notes</th><th>Score</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- News -->
    <section id="news" class="hidden">
      <div class="card">
        <h3>Regulatory & Auditing News</h3>
        <ul id="newsList"></ul>
      </div>
    </section>

    <!-- Alerts -->
    <section id="alerts" class="hidden">
      <div class="card">
        <h3>Active Alerts</h3>
        <ul id="alertsList"></ul>
      </div>
    </section>
  </main>

  <script>
    const $ = (sel, d=document) => d.querySelector(sel);
    const $$ = (sel, d=document) => d.querySelectorAll(sel);

    // Theme
    const body = document.body;
    const themeBtn = $("#theme");
    let light = false;
    themeBtn.onclick = () => {
      light = !light;
      if (light) body.classList.add("light"); else body.classList.remove("light");
    };

    // Tabs
    $$(".tab").forEach(btn => {
      btn.onclick = () => {
        $$(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.dataset.tab;
        $$("main > section").forEach(s => s.classList.add("hidden"));
        $("#" + t).classList.remove("hidden");
      };
    });

    // Health & status
    async function loadHealth() {
      try {
        const h = await fetch("/api/health").then(r=>r.json());
        $("#healthLine").textContent = `OK • ${new Date(h.ts).toLocaleString()}`;
      } catch { $("#healthLine").textContent = "unreachable"; }
      try {
        const s = await fetch("/api/status").then(r=>r.json());
        const u = s.updatedAt || {};
        $("#statusLine").innerHTML = `
          Stablecoins: ${u.stablecoins ? new Date(u.stablecoins).toLocaleTimeString() : "—"} |
          Yields: ${u.yields ? new Date(u.yields).toLocaleTimeString() : "—"} |
          Platforms: ${u.platforms ? new Date(u.platforms).toLocaleTimeString() : "—"} |
          News: ${u.news ? new Date(u.news).toLocaleTimeString() : "—"} |
          Alerts: ${u.alerts ? new Date(u.alerts).toLocaleTimeString() : "—"}
        `;
      } catch { $("#statusLine").textContent = "—"; }
    }

    // Stablecoins
    let STABLES = [];
    async function loadStablecoins() {
      const res = await fetch("/api/stablecoins").then(r=>r.json()).catch(()=>({stablecoins:[]}));
      STABLES = res.stablecoins || [];
      renderStableTable();
    }
    function renderStableTable() {
      const minScore = parseFloat($("#scoreFilter").value);
      $("#scoreVal").textContent = minScore.toFixed(1);
      const tbody = $("#stableTable tbody");
      tbody.innerHTML = "";
      STABLES.filter(s => (s.score || 0) >= minScore).forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill">${s.symbol}</span></td>
          <td>${s.name || ""}</td>
          <td>${s.issuer || ""}</td>
          <td class="muted">${s.jurisdiction || ""}</td>
          <td class="muted">${s.auditor || ""}</td>
          <td class="muted">${s.model || ""}</td>
          <td><b>${(s.score||0).toFixed(1)}</b></td>
        `;
        tbody.appendChild(tr);
      });
    }
    $("#scoreFilter").oninput = renderStableTable;

    // Yields
    async function loadYields() {
      const sym = $("#yieldSymbol").value;
      const url = sym ? `/api/yields?symbol=${encodeURIComponent(sym)}` : "/api/yields";
      const res = await fetch(url).then(r=>r.json()).catch(()=>({pools:[]}));
      const rows = res.pools || [];
      const tbody = $("#yieldTable tbody");
      tbody.innerHTML = "";
      rows.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.project}</td>
          <td class="muted">${p.chain}</td>
          <td>${p.symbol}</td>
          <td><b>${p.apy !== null && p.apy !== undefined ? p.apy.toFixed(2) + "%": "—"}</b></td>
          <td>${p.tvlUsd ? p.tvlUsd.toLocaleString() : "—"}</td>
          <td class="muted"><a href="${p.pool}" target="_blank">view</a></td>
        `;
        tbody.appendChild(tr);
      });
      $("#apySummary").textContent = rows.slice(0,5).map(x=>`${x.symbol}@${x.project}: ${x.apy?x.apy.toFixed(2)+"%":"—"}`).join("  •  ") || "No data";
    }
    $("#yieldSymbol").onchange = loadYields;

    // Platforms
    async function loadPlatforms() {
      const res = await fetch("/api/platforms").then(r=>r.json()).catch(()=>({cefi:[],defi:[]}));
      const ctbody = $("#cefiTable tbody");
      const dtbody = $("#defiTable tbody");
      ctbody.innerHTML = "";
      dtbody.innerHTML = "";
      (res.cefi||[]).forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td class="muted">${p.jurisdiction||""}</td>
          <td class="muted">${(p.licenses||[]).join(", ")}</td>
          <td class="muted">${p.por||""}</td>
          <td><b>${(p.score||0).toFixed(1)}</b></td>
        `;
        ctbody.appendChild(tr);
      });
      (res.defi||[]).forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td class="muted">${p.chain||""}</td>
          <td class="muted">${(p.audits||[]).join(", ")}</td>
          <td class="muted">${p.riskNotes||""}</td>
          <td><b>${(p.score||0).toFixed(1)}</b></td>
        `;
        dtbody.appendChild(tr);
      });
    }

    // News
    async function loadNews() {
      const res = await fetch("/api/news").then(r=>r.json()).catch(()=>({items:[]}));
      const ul = $("#newsList"); ul.innerHTML="";
      (res.items||[]).forEach(it=>{
        const li = document.createElement("li");
        const d = it.date ? new Date(it.date).toLocaleDateString() : "";
        li.innerHTML = `<span class="pill">${it.source}</span> — <a href="${it.link}" target="_blank">${it.title}</a> <span class="muted">${d}</span>`;
        ul.appendChild(li);
      });
    }

    // Alerts
    async function loadAlerts() {
      const res = await fetch("/api/alerts").then(r=>r.json()).catch(()=>({alerts:[]}));
      const ul = $("#alertsList"); ul.innerHTML="";
      (res.alerts||[]).forEach(a=>{
        const li = document.createElement("li");
        const sev = a.severity==="high"?"bad":(a.severity==="medium"?"warn":"ok");
        li.innerHTML = `<span class="pill ${sev}">${a.type}</span> ${a.message || ""} ${a.link?`<a href="${a.link}" target="_blank">details</a>`:""}`;
        ul.appendChild(li);
      });
    }

    // Boot
    (async function init(){
      await loadHealth();
      await loadStablecoins();
      await loadYields();
      await loadPlatforms();
      await loadNews();
      await loadAlerts();
      // Refresh some data periodically
      setInterval(loadHealth, 60_000);
      setInterval(loadYields, 180_000);
      setInterval(loadNews, 300_000);
      setInterval(loadAlerts, 120_000);
    })();
  </script>
</body>
</html>

